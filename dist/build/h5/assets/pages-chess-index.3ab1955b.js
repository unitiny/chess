var e=Object.defineProperty,t=(t,s,a)=>(((t,s,a)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a})(t,"symbol"!=typeof s?s+"":s,a),a);import{s,h as a,j as l,k as n,z as o,A as u,l as i,o as c,c as r,w as f,a as h,u as d,d as v,e as m,m as g,p,B as y,t as x,F as S,v as T,i as C,f as _,S as k,I as M,C as b,n as O,b as E}from"./index.7ff0e1fc.js";import{C as H,b as A,d as w,c as I,i as N,S as B,e as K,E as G,f as L,K as D,M as P,g as R,h as J,_ as W,j as $,k as V,s as j,l as U,U as q,n as z,o as F,p as Y,q as Q,A as X,T as Z,t as ee,u as te}from"./common.dd1c9a59.js";class se{constructor(){t(this,"width"),t(this,"height"),t(this,"lt_pos"),t(this,"landing"),this.width=H.WIDTH,this.height=H.HEIGHT,this.lt_pos=H.LT_POS,this.landing={hidden:!0,blueBox:"../../static/img/blueBox.png",redBox:"../../static/img/redBox.png",box:"../../static/img/redBox.png",style:""}}getLanding(e){this.landing.hidden=!1;let t=H.LT_POS[0]-A.WIDTH/2+H.WIDTH*e[0]+"rpx",s=H.LT_POS[1]-A.HEIGHT/2+H.HEIGHT*e[1]+10+"rpx";this.landing.style=`left:${t};top: ${s}`}getPos(e){let{x:t,y:a}=e.detail;a+=30,t*=s.state.ratio,a*=s.state.ratio;const l=H.WIDTH,n=H.HEIGHT,o=H.LT_POS[0],u=H.LT_POS[1];let i=Math.abs(Math.round((t-o)/l)),c=Math.abs(Math.round((a-u)/n));i=i>=9?8:i,c=c>=10?9:c;let r=[i,c];return this.getLanding(r),setTimeout((()=>{this.landing.hidden=!0}),200),r}}let ae={};function le(e,t){return{start:{x:e[0],y:e[1]},end:{x:t[0],y:t[1]}}}function ne(e,t){for(let s=0;s<e.length;s++){let a=e[s];if(a.x===t[0]&&a.y===t[1]&&a.live)return s}return-1}function oe(e,t){let s=e[t],a=[[1,0],[-1,0],[0,1],[0,-1]],l=[];for(let i=0;i<a.length;i++){let t=a[i],n=[s.x+t[0],s.y+t[1]],o=ne(e,n);if(-1!==o){let t=e[o];if(N(t.status,s.camp))continue}l.push(n)}let n=[],o=[s.x,s.y];for(let i=0;i<l.length;i++){let e=l[i];try{B(o,e,s.bottom);let t={start:{x:s.x,y:s.y},end:{x:e[0],y:e[1]}};n.push(t)}catch(u){}}return n}function ue(e,t){let s=e[t],a=[],l=[s.x,s.y],n=!1;for(let o=s.y-1;o>=0;o--){let t=[s.x,o];if(n){let n=ne(e,t);if(-1!==n){if(!N(e[n].status,s.camp)){let e=le(l,t);a.push(e)}break}}else if(-1===ne(e,t)){let e=le(l,t);a.push(e)}else n=!0}n=!1;for(let o=s.y+1;o<=9;o++){let t=[s.x,o];if(n){let n=ne(e,t);if(-1!==n){if(!N(e[n].status,s.camp)){let e=le(l,t);a.push(e)}break}}else if(-1===ne(e,t)){let e=le(l,t);a.push(e)}else n=!0}n=!1;for(let o=s.x-1;o>=0;o--){let t=[o,s.y];if(n){let n=ne(e,t);if(-1!==n){if(!N(e[n].status,s.camp)){let e=le(l,t);a.push(e)}break}}else if(-1===ne(e,t)){let e=le(l,t);a.push(e)}else n=!0}n=!1;for(let o=s.x+1;o<=8;o++){let t=[o,s.y];if(n){let n=ne(e,t);if(-1!==n){if(!N(e[n].status,s.camp)){let e=le(l,t);a.push(e)}break}}else if(-1===ne(e,t)){let e=le(l,t);a.push(e)}else n=!0}return a}function ie(e,t){let s=e[t],a=[],l=[s.x,s.y];for(let n=s.y-1;n>=0;n--){let t=[s.x,n],o=ne(e,t);if(-1!==o){if(!N(e[o].status,s.camp)){let e=le(l,t);a.push(e)}break}let u=le(l,t);a.push(u)}for(let n=s.y+1;n<=9;n++){let t=[s.x,n],o=ne(e,t);if(-1!==o){if(!N(e[o].status,s.camp)){let e=le(l,t);a.push(e)}break}let u=le(l,t);a.push(u)}for(let n=s.x-1;n>=0;n--){let t=[n,s.y],o=ne(e,t);if(-1!==o){if(!N(e[o].status,s.camp)){let e=le(l,t);a.push(e)}break}let u=le(l,t);a.push(u)}for(let n=s.x+1;n<=8;n++){let t=[n,s.y],o=ne(e,t);if(-1!==o){if(!N(e[o].status,s.camp)){let e=le(l,t);a.push(e)}break}let u=le(l,t);a.push(u)}return a}function ce(e,t){let s=e[t],a=[[1,2],[1,-2],[-1,2],[-1,-2],[2,1],[2,-1],[-2,1],[-2,-1]],l=[];for(let i=0;i<a.length;i++){let t=a[i],n=[s.x+t[0],s.y+t[1]],o=ne(e,n);if(-1!==o){let t=e[o];if(N(t.status,s.camp))continue}l.push(n)}let n=[],o=[s.x,s.y];for(let i=0;i<l.length;i++){let t=l[i];try{K(e,o,t,s.bottom);let a={start:{x:s.x,y:s.y},end:{x:t[0],y:t[1]}};n.push(a)}catch(u){}}return n}function re(e,t){let s=e[t],a=[[2,2],[2,-2],[-2,2],[-2,-2]],l=[];for(let i=0;i<a.length;i++){let t=a[i],n=[s.x+t[0],s.y+t[1]],o=ne(e,n);if(-1!==o){let t=e[o];if(N(t.status,s.camp))continue}l.push(n)}let n=[],o=[s.x,s.y];for(let i=0;i<l.length;i++){let t=l[i];try{G(e,o,t,s.bottom);let a={start:{x:s.x,y:s.y},end:{x:t[0],y:t[1]}};n.push(a)}catch(u){}}return n}function fe(e,t){let s=e[t],a=[[1,1],[-1,1],[1,-1],[-1,-1]],l=[];for(let i=0;i<a.length;i++){let t=a[i],n=[s.x+t[0],s.y+t[1]];if(n[1]<0||n[1]>9)continue;let o=ne(e,n);if(-1!==o){let t=e[o];if(N(t.status,s.camp))continue}l.push(n)}let n=[],o=[s.x,s.y];for(let i=0;i<l.length;i++){let e=l[i];try{L(o,e,s.bottom);let t={start:{x:s.x,y:s.y},end:{x:e[0],y:e[1]}};n.push(t)}catch(u){}}return n}function he(e,t){let s=e[t],a=[[1,0],[-1,0],[0,1],[0,-1]],l=[];for(let i=0;i<a.length;i++){let t=a[i],n=[s.x+t[0],s.y+t[1]],o=ne(e,n);if(-1!==o){let t=e[o];if(N(t.status,s.camp))continue}l.push(n)}for(let i=0;i<e.length;i++)if(e[i].name===I.KING&&!N(e[i].status,s.camp)){let t=[e[i].x,e[i].y];l.push(t)}let n=[],o=[s.x,s.y];for(let i=0;i<l.length;i++){let t=l[i];try{D(e,o,t,s.bottom);let a={start:{x:s.x,y:s.y},end:{x:t[0],y:t[1]}};n.push(a)}catch(u){}}return n}function de(e,t){let s=w(e),a=function(e,t){let s=[];for(let a=0;a<e.length;a++){let l=e[a];if(l.live&&N(l.status,t.toString())){let t=ae[l.name](e,a);for(let e=0;e<t.length;e++){let l={index:a,Move:t[e]};s.push(l)}}}return s}(s,t);for(let l=0;l<a.length;l++){let e=ve(s,a[l]);if(!ge(s,t))return!1;me(s,a[l],e)}return!0}function ve(e,t){let s=ne(e,t.Move.end);return e[t.index].x=t.Move.end.x,e[t.index].y=t.Move.end.y,-1!==s&&e[s].die(),s}function me(e,t,s){e[t.index].x=t.Move.start.x,e[t.index].y=t.Move.start.y,-1!==s&&e[s].alive()}function ge(e,t){let s={x:0,y:0};for(let a=0;a<e.length;a++)e[a].name===I.KING&&N(e[a].status,t.toString())&&(s.x=e[a].x,s.y=e[a].y);for(let a=0;a<e.length;a++)if(e[a].live&&!N(e[a].status,t.toString())){let t=ae[e[a].name](e,a);for(let e=0;e<t.length;e++)if(JSON.stringify(t[e].end)===JSON.stringify(s))return!0}return!1}ae[I.SOLDIER]=oe,ae[I.CANNON]=ue,ae[I.CAR]=ie,ae[I.HORSE]=ce,ae[I.ELEPHANT]=re,ae[I.SCHOLAR]=fe,ae[I.KING]=he;class pe{constructor(e){t(this,"url"),t(this,"ws"),t(this,"message"),t(this,"connected"),this.url=e,this.message={action:P.NOT_ACTION,message:""},this.init()}init(){this.ws=new WebSocket(this.url),this.ws.onopen=e=>{console.log("open"),this.connected=!0},this.ws.onmessage=e=>{console.log("onmessage",e),this.handlerMsg(e.data)},this.ws.onerror=e=>{console.log("error",e),this.connected=!1},this.ws.onclose=e=>{console.log("onclose",e),this.connected=!1}}close(){this.ws.close()}handlerMsg(e){let t=JSON.parse(e);R(t.content)&&(this.message={},this.message=JSON.parse(t.content)),this.message.hasOwnProperty("message")||(this.message.action=1,this.message.message=t.content,this.message.name=J,this.message.machine=!0),s.commit("updateReceive",!0)}sendMsg(e,t){e.name=t||s.state.name,console.log("sendMsg",e);let a=JSON.stringify(e);this.ws.send(a)}sendMachineMsg(e){console.log("sendMachineMsg",e);let t=JSON.stringify(e);this.ws.send(t)}}var ye=W(a({emits:["start","tryBack","goBack","choose","moveChess","attackTheChess","machineStep"],setup(e,{expose:t,emit:a}){let b=l($);const O=n({menu:!1,start:!1,chat:!1,status:"11"}),E=l(o((()=>s.state.tip))),H=n({messages:[],isSelf:[],editMsg:""}),A=l(s.state.mode);let w=n(W());function I(e){for(const t in O)"boolean"==typeof O[t]&&(O[t]=t===e&&!O[t])}async function B(){if(null!==w&&w.close(),w=n(W()),a("start"),I(z.START),await ee()&&(G(Q.CLEAR),N(A.value,"00",1)||N(A.value,"00"))){let e={action:Q.GO,room:s.state.room,start:{},end:{}};w.sendMachineMsg(e)}}function K(){console.log("sendMsg",H.editMsg);let e={action:P.CHAT,message:H.editMsg};w.sendMsg(e),H.editMsg=""}function G(e){let t={action:e,room:s.state.room};w.sendMachineMsg(t)}function L(){a("tryBack")}function D(){T({url:"../index/index"}),w.close()}function W(){let{name:e,room:t,mode:a}=s.state,l="1";if(!Z(a)){if(N(a,"11",1))return null;l="2"}let n=`${X.chat}?name=${e}&room=${t}&action=${l}`;return new pe(n)}function Z(e){return V(e,"10000")}const ee=async()=>!(null===w||!w.connected)||(await new Promise((e=>{setTimeout(e,500)})),await ee());return u((()=>O.status),(()=>{if(Z(A.value))V(O.status,"1")?(b.value[0].span="先手",A.value=j(A.value,"1")):(b.value[0].span="后手",A.value=U(A.value,"1"));else switch(b.value[0].span=V(O.status,"10")?"棋手":"电脑",b.value[1].span=V(O.status,"1")?"棋手":"电脑",O.status){case"0":A.value=j(A.value,"1001"),A.value=U(A.value,"110");break;case"1":A.value=U(A.value,"11");break;case"10":A.value=U(A.value,"10");break;case"11":A.value=j(A.value,"111")}s.commit("updateMode",A.value)}),{deep:!0}),u((()=>s.state.receive),(e=>{if(e){switch(console.log("watch",w.message),w.message.action){case 0:H.messages.push(w.message.message),w.message.name===s.state.name?H.isSelf.push(!0):H.isSelf.push(!1);break;case 1:if(w.message.name!==s.state.name&&w.message.name!==J){console.log("opponent chess move");try{let e=JSON.parse(w.message.message),t=31-e.index,s=e.end;e.action===q.MOVE_CHESS?(console.log(e.action,t,s),a("choose",t),a("moveChess",t,s)):e.action===q.ATTACK_CHESS&&(a("choose",t),a("attackTheChess",t,s))}catch(t){console.log(t)}}else w.message.name===J&&R(w.message.message)&&(console.log("machine chess move"),a("machineStep",w.message.message));break;case 2:w.message.name!==s.state.name&&a("goBack")}w.message={},s.commit("updateReceive",!1)}})),i((()=>{for(const e in z){let t=z[e];O[t]=!1}Z(A.value)&&(b.value=F,O.status=V(A.value,"1")?"1":"0")})),t({sendStep:function(e){let t=JSON.parse(JSON.stringify(e)),{start:s,end:a}=t,l=[8-s[0],9-s[1]],n=[8-a[0],9-a[1]];if(t.start=l,t.end=n,Z(A.value)||V(A.value,"10")){if(Z(A.value)||!N(A.value,"11",1)){let e={action:P.CHESS,message:JSON.stringify(t)};w.sendMsg(e)}}else{N(A.value,"00")&&(s=[8-s[0],9-s[1]],a=[8-a[0],9-a[1]]);let t={action:Q.GO,room:e.room.toString(),start:{x:s[0],y:s[1]},end:{x:a[0],y:a[1]}};w.sendMachineMsg(t)}},isDoubleGame:Z,sendAction:function(e){let t={action:e,message:""};w.sendMsg(t)},sendMachineAction:G}),(e,t)=>{const s=C,a=_,l=k,n=M;return c(),r(a,{class:"content"},{default:f((()=>[h(a,{class:"edit"},{default:f((()=>[h(s,{src:"/h5/assets/red-king.3c50a97a.png",onClick:t[0]||(t[0]=e=>I(d(z).MENU))}),h(a,{class:"panel"},{default:f((()=>[h(a,{onClick:t[1]||(t[1]=e=>I(d(z).START))},{default:f((()=>[v("新局")])),_:1}),h(a,{onClick:t[2]||(t[2]=e=>I(d(z).CHAT))},{default:f((()=>[v("聊天")])),_:1}),h(a,{onClick:L},{default:f((()=>[v("悔棋")])),_:1})])),_:1})])),_:1}),h(a,{class:m({mask:!0,hidden:!d(O).menu})},{default:f((()=>[h(a,{class:"model"},{default:f((()=>[h(a,{class:"confirm",onClick:D},{default:f((()=>[v("退出")])),_:1})])),_:1})])),_:1},8,["class"]),h(a,{class:m({mask:!0,hidden:!d(O).start})},{default:f((()=>[h(a,{class:"model"},{default:f((()=>[(c(!0),g(S,null,p(d(b),((e,t)=>(c(),r(a,{key:t},{default:f((()=>[y("span",null,x(e.text),1),y("span",{class:"block",onClick:e=>function(e){if(Z(A.value))O.status=Y(O.status,"1");else{let t=0===e?"10":"1";O.status=Y(O.status,t)}}(t)},x(e.span),9,["onClick"])])),_:2},1024)))),128)),h(a,{class:"confirm",onClick:B},{default:f((()=>[v("确定")])),_:1})])),_:1})])),_:1},8,["class"]),h(a,{class:m({mask:!0,hidden:!d(O).chat})},{default:f((()=>[h(a,{class:"model chat"},{default:f((()=>[h(l,{"scroll-y":"true",class:"scroll-Y"},{default:f((()=>[(c(!0),g(S,null,p(d(H).messages,((e,t)=>(c(),r(a,{class:m({message:!0,self:d(H).isSelf[t]}),key:t},{default:f((()=>[v(x(e),1)])),_:2},1032,["class"])))),128))])),_:1}),h(a,{class:"send"},{default:f((()=>[h(n,{type:"text",value:d(H).editMsg,"onUpdate:value":t[3]||(t[3]=e=>d(H).editMsg=e)},null,8,["value"]),y("span",{class:"button",onClick:K},"发送")])),_:1})])),_:1})])),_:1},8,["class"]),h(a,{class:m({tip:!0,hidden:""===E.value})},{default:f((()=>[v(x(E.value),1)])),_:1},8,["class"])])),_:1})}}}),[["__scopeId","data-v-63425d90"]]);const xe=a({setup(e,{expose:t}){const s=b(),a=b();return b(),i((()=>{s.src="/static/audio/king.mp3",s.startTime=.3,a.src="/static/audio/move.mp3"})),t({king:function(){s.play()},move:function(){a.play(),setTimeout((()=>{a.stop()}),300)}}),(e,t)=>{const s=_;return c(),r(s)}}});var Se=W(a({setup(e){const t=l(null),a=l(null),v=l(null),y=l(null),x=l([]),T=l(0),k=l(2),M=n([]),b=l(o((()=>s.state.mode))),w=l(!1),I=n(new se);function B(e){if(k.value=1,1===e)return void K();let t=H.RED_BOTTOM;H.RED_BOTTOM=H.BLACK_BOTTOM,H.BLACK_BOTTOM=t,K();for(let s=0;s<x.value.length;s++)x.value[s].status=Y(x.value[s].status,"1")}function K(){x.value.length=0;for(let e=0;e<ee.length;e++){let t=ee[e];x.value.push(new te(t.x,t.y,t.name,t.camp))}}function G(){console.log("mode",b.value),N(b.value,"00",1)?(console.log("两人机"),B(1)):(a.value.isDoubleGame(b.value)||N(b.value,"11",1)||console.log("玩家和人机"),V(b.value,"1")?B(1):B(0)),w.value=!1}function L(e){if(w.value)return;let t=I.getPos(e),s=function(e){for(let t=0;t<x.value.length;t++){let s=x.value[t];if(s.live&&(s.x===e[0]&&s.y===e[1])){if(X(t,k.value))return q.CHOOSE_CHESS;if(X(T.value,k.value)&&ae(T.value))return q.ATTACK_CHESS}}if(X(T.value,k.value))return q.MOVE_CHESS;return q.NOT_ACTION}(t),l=z(t);console.log(t,s,l);try{switch(s){case q.CHOOSE_CHESS:!function(e){if(!N(b.value,e.toString())){if(a.value.isDoubleGame(b.value))throw new Error("不能选择对方阵营棋子");!a.value.isDoubleGame(b.value)&&V(b.value,"10")}}(k.value),le(l);break;case q.MOVE_CHESS:D(T.value,t);break;case q.ATTACK_CHESS:R(T.value,t)}}catch(n){console.log(n)}}function D(e,t){$(e,t),F(),ne(),ue()}function R(e,t){!function(e,t){let s=z(t);x.value[s].status=U(x.value[s].status,"10"),x.value[e].attack();try{$(e,t);let a=M.length;M[a-1].eat=s}catch(a){throw x.value[s].status=j(x.value[s].status,"10"),new Error(a)}finally{x.value[e].move()}}(e,t),F(),ne(),ue()}function J(){if(a.value.isDoubleGame(b.value)){if(N(b.value,k.value.toString()))return void s.commit("updateTip",Z.NOT_BACK);a.value.sendAction(P.BACK),W()}else N(b.value,"10",1)&&(a.value.sendMachineAction(Q.BACK),W())}function W(){let e=M.length;if(0===e)return;let t=M[e-1];M.splice(e-1,1),t.eat&&(x.value[t.eat].status=j(x.value[t.eat].status,"10")),T.value=t.index,x.value[T.value].status=j(x.value[T.value].status,"10100"),$(T.value,t.start),x.value[T.value].status=U(x.value[T.value].status,"10100"),k.value=1^k.value,ne()}function $(e,t){let l=[x.value[e].x,x.value[e].y];x.value[e].changePos(x.value,t),V(x.value[e].status,"10000")||(!function(e,t){let l=x.value[e],n=V(l.status,"1000")?q.ATTACK_CHESS:q.MOVE_CHESS,o={index:l.id,start:t,end:[l.x,l.y],action:n,camp:l.camp,room:s.state.room};M.push(o);let u=b.value[b.value.length-1];s.state.tip!==Z.KILLED_KING&&(N(b.value,"00",1)?(a.value.sendMachineAction(Q.BACK),a.value.sendStep(o)):N(l.status,u)&&a.value.sendStep(o))}(e,l),v.value.move())}function z(e){for(let t=0;t<x.value.length;t++){let s=x.value[t];if(s.x===e[0]&&s.y===e[1]&&s.live)return t}return-1}function F(){k.value=0===k.value?1:0,x.value=x.value.map(((e,t)=>(!X(t,k.value)&&e.isChoose()&&e.notChoose(),e)))}function X(e,t){let s=x.value[e];return N(s.status,t.toString())}function ae(e){return x.value[e].isChoose()}function le(e){let t=x.value[T.value],s=x.value[e];s.choose(),e!==T.value&&t.notChoose(),x.value[T.value]=t,x.value[e]=s,T.value=e}function ne(){setTimeout((()=>{I.landing.hidden=!0,I.landing.box=k.value?I.landing.redBox:I.landing.blueBox}),200)}function oe(e){let t=JSON.parse(e);t.start=[t.start.x,t.start.y],t.end=[t.end.x,t.end.y],N(b.value,"00")&&(t.start=[8-t.start[0],9-t.start[1]],t.end=[8-t.end[0],9-t.end[1]]);let s=z(t.start),a=z(t.end),l=q.ATTACK_CHESS;-1===a&&(l=q.MOVE_CHESS);try{console.log("machineStep ",t,l),l===q.MOVE_CHESS?(le(s),D(s,t.end)):l===q.ATTACK_CHESS&&(le(s),R(s,t.end))}catch(n){console.log(n)}}function ue(){de(x.value,k.value)&&(console.log("绝杀"),w.value=!0,s.commit("updateTip",Z.CHECKMATE))}return i((()=>{!function(){let e=750/t.value.$el.offsetWidth;s.commit("updateRatio",e);let a=y.value.$el;H.LT_POS=[(a.offsetLeft+5)*e,(a.offsetTop+10)*e],H.WIDTH=(a.offsetWidth-10)*e/8,H.HEIGHT=(a.offsetHeight-20)*e/9,A.WIDTH=H.WIDTH,A.HEIGHT=H.HEIGHT}(),G()})),u((()=>s.state.tip),(e=>{e===Z.KILLED_KING?setTimeout((()=>{W()}),600):e===Z.KILL_KING&&v.value.king(),setTimeout((()=>{s.commit("updateTip","")}),800)})),(e,s)=>{const l=C,n=_;return c(),r(n,{ref_key:"refContent",ref:t,class:"content"},{default:f((()=>[h(ye,{ref_key:"refEdit",ref:a,onStart:G,onTryBack:J,onGoBack:W,onChoose:le,onMoveChess:D,onAttackTheChess:R,onMachineStep:oe},null,512),h(xe,{ref_key:"refAudio",ref:v},null,512),h(l,{ref_key:"refBoard",ref:y,src:"/h5/assets/chessboard.2b88416f.png",class:"board",onClick:L},null,512),h(n,{class:m(d(I).landing.class),style:O(d(I).landing.style)},null,8,["class","style"]),h(l,{class:m({"chess box":!0,hidden:d(I).landing.hidden}),style:O(d(I).landing.style),src:d(I).landing.box},null,8,["class","style","src"]),(c(!0),g(S,null,p(x.value,(e=>(c(),r(n,{key:e.id},{default:f((()=>[e.live?(c(),r(n,{key:0,class:"chess",style:O(e.style)},{default:f((()=>[h(l,{src:e.path.chess},null,8,["src"]),h(l,{class:m({box:!0,hidden:e.hiddenBox}),src:d(I).landing.box},null,8,["class","src"])])),_:2},1032,["style"])):E("v-if",!0)])),_:2},1024)))),128))])),_:1},512)}}}),[["__scopeId","data-v-59619372"]]);export{Se as default};
